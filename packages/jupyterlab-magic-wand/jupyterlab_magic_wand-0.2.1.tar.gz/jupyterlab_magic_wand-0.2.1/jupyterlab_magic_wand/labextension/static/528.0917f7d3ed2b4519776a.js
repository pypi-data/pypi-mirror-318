"use strict";(self.webpackChunkjupyterlab_magic_wand=self.webpackChunkjupyterlab_magic_wand||[]).push([[528],{528:(e,t,n)=>{n.r(t),n.d(t,{default:()=>x});var l=n(338),o=n(228),i=n(262),a=n(602),c=n(256),s=n(213),r=n(597),d=n(358),u=n(960);const m=new u.LabIcon({name:"wand:Icon",svgstr:'<svg\n  viewBox="0 0 24 24"\n  version="1.1"\n  xmlns="http://www.w3.org/2000/svg"\n  xmlns:xlink="http://www.w3.org/1999/xlink"\n>\n  <g class="jp-icon3" fill="#616161">\n    <path\n        d="M7.5 5.6 10 7 8.6 4.5 10 2 7.5 3.4 5 2l1.4 2.5L5 7zm12 9.8L17 14l1.4 2.5L17 19l2.5-1.4L22 19l-1.4-2.5L22 14zM22 2l-2.5 1.4L17 2l1.4 2.5L17 7l2.5-1.4L22 7l-1.4-2.5zm-7.63 5.29a.9959.9959 0 0 0-1.41 0L1.29 18.96c-.39.39-.39 1.02 0 1.41l2.34 2.34c.39.39 1.02.39 1.41 0L16.7 11.05c.39-.39.39-1.02 0-1.41zm-1.03 5.49-2.12-2.12 2.44-2.44 2.12 2.12z"\n    ></path>\n  </g>\n</svg>'}),g=new u.LabIcon({name:"spinner:Icon",svgstr:'<svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24"><circle cx="4" cy="12" r="3" fill="currentColor"><animate id="svgSpinners3DotsFade0" fill="freeze" attributeName="opacity" begin="0;svgSpinners3DotsFade1.end-0.25s" dur="0.75s" values="1;0.2"/></circle><circle cx="12" cy="12" r="3" fill="currentColor" opacity="0.4"><animate fill="freeze" attributeName="opacity" begin="svgSpinners3DotsFade0.begin+0.15s" dur="0.75s" values="1;0.2"/></circle><circle cx="20" cy="12" r="3" fill="currentColor" opacity="0.3"><animate id="svgSpinners3DotsFade1" fill="freeze" attributeName="opacity" begin="svgSpinners3DotsFade0.begin+0.3s" dur="0.75s" values="1;0.2"/></circle></svg>'});new u.LabIcon({name:"thumbUp:Icon",svgstr:'<svg\n  viewBox="0 0 28 28"\n  version="1.1"\n  xmlns="http://www.w3.org/2000/svg"\n  xmlns:xlink="http://www.w3.org/1999/xlink"\n>\n  <g class="jp-icon3" fill="#616161" fill-opacity="0" stroke="#616161" stroke-width="2px">\n    <path\n        d="M1 21h4V9H1zm22-11c0-1.1-.9-2-2-2h-6.31l.95-4.57.03-.32c0-.41-.17-.79-.44-1.06L14.17 1 7.59 7.59C7.22 7.95 7 8.45 7 9v10c0 1.1.9 2 2 2h9c.83 0 1.54-.5 1.84-1.22l3.02-7.05c.09-.23.14-.47.14-.73z"\n    ></path>\n  </g>\n</svg>'}),new u.LabIcon({name:"thumbDown:Icon",svgstr:'<svg\n  viewBox="0 0 28 28"\n  version="1.1"\n  xmlns="http://www.w3.org/2000/svg"\n  xmlns:xlink="http://www.w3.org/1999/xlink"\n>\n  <g class="jp-icon3" fill="#616161" fill-opacity="0" stroke="#616161" stroke-width="2px">\n    <path\n        d="M15 3H6c-.83 0-1.54.5-1.84 1.22l-3.02 7.05c-.09.23-.14.47-.14.73v2c0 1.1.9 2 2 2h6.31l-.95 4.57-.03.32c0 .41.17.79.44 1.06L9.83 23l6.59-6.59c.36-.36.58-.86.58-1.41V5c0-1.1-.9-2-2-2m4 0v12h4V3z"\n    ></path>\n  </g>\n</svg>'}),new u.LabIcon({name:"feedback:Icon",svgstr:'<svg\n  viewBox="0 0 28 28"\n  version="1.1"\n  xmlns="http://www.w3.org/2000/svg"\n  xmlns:xlink="http://www.w3.org/1999/xlink"\n>\n  <g class="jp-icon3" fill="#616161">\n    <path\n        d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2m0 14H5.17l-.59.59-.58.58V4h16zm-9.5-2H18v-2h-5.5zm3.86-5.87c.2-.2.2-.51 0-.71l-1.77-1.77c-.2-.2-.51-.2-.71 0L6 11.53V14h2.47z"\n    ></path>\n  </g>\n</svg>'});var v=n(963);function p(e){const t=null==e?void 0:e.model.sharedModel.getSource();null==e||e.model.selections;let n=null;if("code"===(null==e?void 0:e.model.type)){const t=e,l=t.outputArea.model.length-1,o=t.outputArea.model.get(l);if(o&&"error"===o.type){const e=o.data["application/vnd.jupyter.error"];e&&(n=e.ename+": "+e.evalue)}}return{cell_id:null==e?void 0:e.model.sharedModel.getId(),type:null==e?void 0:e.model.type,error:n,source:t}}function h(e,t){var n,l,o;const i=null===(l=null===(n=e.model)||void 0===n?void 0:n.cells.get(t))||void 0===l?void 0:l.id;if(i){const t=null===(o=e._findCellById(i))||void 0===o?void 0:o.cell;if(t)return t}}function w(e,t){var n,l;const o=t.currentWidget,i=null===(l=null===(n=t.currentWidget)||void 0===n?void 0:n.content._findCellById(e))||void 0===l?void 0:l.cell;if(o&&i)return{cell:i,notebook:o};const a=t.find((t=>{var n;return!!(null===(n=t.content._findCellById(e))||void 0===n?void 0:n.cell)}));return{cell:i,notebook:a}}var f=n(345);const b=new i.Token("AICellTracker");class y{constructor(e,t,n,l){this.commandId="jupyterlab_magic_wand:improve-cell",this.eventSchemaId="https://events.jupyter.org/jupyter_ai/magic_button/v1",this.pendingCells=new Map,this._responseHappened=new a.Signal(this),this._notebookTracker=t,this._eventListener=n,this._commandRegistry=e,this._cellFooterTracker=l,this._eventListener.addListener(this.eventSchemaId,(async(e,t,n)=>{await this.response(n)})),this._eventListener.addListener("https://events.jupyter.org/jupyter_ai/error/v1",(async(e,t,n)=>{const l=n;this.pendingCells.delete(l.reply_to),this._commandRegistry.notifyCommandChanged(this.commandId);const{cell:o}=this.findCell(l.reply_to);null==o||o.model.setMetadata("editable",!0),null==o||o.saveEditableState(),s.Notification.error("An error occurred with the AI Magic button.",{autoClose:5e3,actions:[{label:"Read more",callback:()=>{var e,t;e=l.error_type,t=l.message,(0,s.showDialog)({title:f.createElement("div",{className:"jp-MagicDialog-header"},f.createElement(m.react,{tag:"div",className:"jp-MagicDialog-icon"}),f.createElement("div",{className:"jp-MagicDialog-title"},"Oops! ",e)),body:f.createElement("div",null,f.createElement("p",null),f.createElement("pre",{className:"jp-MagicDialog-code"},f.createElement("code",null,t)),f.createElement("p",null,"We recommend that you try again. If the problem persists, please open an issue on Github!")),buttons:[s.Dialog.okButton()]})}}]})})),this._commandRegistry.addCommand(this.commandId,{label:e=>this.label(),icon:e=>this.icon(e),execute:e=>this.execute(),isEnabled:e=>this.isEnabled()}),this.responseHappened.connect((()=>{this._commandRegistry.notifyCommandChanged(this.commandId)}))}async response(e){const t=e,n=t.context.cell_id;if(n){const e=this.pendingCells.get(n);e&&clearTimeout(e);const{cell:l}=this.findCell(n);null==l||l.model.setMetadata("editable",!0),null==l||l.saveEditableState(),this.pendingCells.delete(n);const o={...null==l?void 0:l.model.getMetadata("jupyter_ai"),agent:t.agent,messages:t.messages};if(null==l||l.model.setMetadata("jupyter_ai",o),l){const e=this._cellFooterTracker.getFooter(n);null==e||e.removeToolbarItem("magicIcon");const t=new c.Widget({node:m.element()});t.addClass("jp-Toolbar-Icon"),null==e||e.addToolbarItemOnLeft("magicIcon",t),this._cellFooterTracker.showFooter(n)}this._responseHappened.emit({cell:l,response:t})}t.commands&&t.commands.forEach((async e=>{try{await this._commandRegistry.execute(e.name,e.args)}catch(t){console.log("Could not execute AI command: "+e.name),console.error(t)}}))}get responseHappened(){return this._responseHappened}label(){const e=this.getCurrentActiveCellId();return e&&e in this.pendingCells?"AI is thinking...":"AI, please help!"}icon(e){const t=this.getCurrentActiveCellId();return t&&this.pendingCells.get(t)?g:m}isEnabled(){const e=this.getCurrentActiveCellId();return!e||!this.pendingCells.get(e)}getCurrentActiveCell(){var e;return null===(e=this._notebookTracker.currentWidget)||void 0===e?void 0:e.content.activeCell}getCurrentActiveCellId(){var e,t;const n=this._notebookTracker.currentWidget,l=null==n?void 0:n.content.activeCellIndex;if(void 0!==l&&n)return null===(t=null===(e=n.model)||void 0===e?void 0:e.cells.get(l))||void 0===t?void 0:t.id}findCell(e){var t,n;const l=this._notebookTracker.currentWidget,o=null===(n=null===(t=this._notebookTracker.currentWidget)||void 0===t?void 0:t.content._findCellById(e))||void 0===n?void 0:n.cell;if(l&&o)return{cell:o,notebook:l};const i=this._notebookTracker.find((t=>{var n;return!!(null===(n=t.content._findCellById(e))||void 0===n?void 0:n.cell)}));return{cell:o,notebook:i}}async execute(){var e,t;const n=this._notebookTracker.currentWidget,l=function(e){const t=function(e){if(!(e instanceof v.DocumentWidget))return null;const{content:t}=e;return t instanceof o.Notebook?t:null}(e);if(!t)return null;const n=t.activeCellIndex,l=t.activeCell;if(!l)return null;const i=p(l),a=h(t,n-1);let c=null;a&&(c=p(a));const s=h(t,n+1);let r=null;return s&&(r=p(s)),{previous:c,current:i,next:r}}(n),i=this.getCurrentActiveCell();if(null==i||i.model.setMetadata("editable",!1),null==i||i.saveEditableState(),!l)return void console.log("AI Command not focused on a cell.");const a=l.current.cell_id,c=setTimeout((()=>{console.log("AI request timed out."),this.pendingCells.delete(a),this._commandRegistry.notifyCommandChanged(this.commandId),s.Notification.warning("The AI Magic button timed out.",{autoClose:5e3,actions:[{label:"Read more",callback:()=>{var e;e=null==l?void 0:l.current.source,(0,s.showDialog)({title:f.createElement("div",{className:"jp-MagicDialog-header"},f.createElement(m.react,{tag:"div",className:"jp-MagicDialog-icon"}),f.createElement("div",{className:"jp-MagicDialog-title"},"Oops! The magic button timed out.")),body:f.createElement("div",null,f.createElement("p",null,"The magic button timed out in the cell with the following content:"),f.createElement("pre",{className:"jp-MagicDialog-code"},f.createElement("code",null,e)),f.createElement("p",null,"We recommend that you try again. If the problem persists, please open an issue on Github!")),buttons:[s.Dialog.okButton()]})}}]}),null==i||i.model.setMetadata("editable",!0),null==i||i.saveEditableState()}),18e5);this.pendingCells.set(a,c);const u=null===(e=null==i?void 0:i.model)||void 0===e?void 0:e.sharedModel.getSource();!async function(e="",t={}){const n=d.ServerConnection.makeSettings(),l=r.URLExt.join(n.baseUrl,e);let o;try{o=await d.ServerConnection.makeRequest(l,t,n)}catch(e){throw new d.ServerConnection.NetworkError(e)}let i=await o.text();if(i.length>0)try{i=JSON.parse(i)}catch(e){console.log("Not a JSON response body.",o)}if(!o.ok)throw new d.ServerConnection.ResponseError(o,i.message||i)}("/api/ai/magic",{method:"POST",body:JSON.stringify({input:u,context:{cell_id:a,content:null===(t=null==n?void 0:n.content.model)||void 0===t?void 0:t.toJSON()},commands:[]})}),this._commandRegistry.notifyCommandChanged(this.commandId)}}var C=n(51),k=n(356);const _="jupyterlab_magic_wand",I={id:_+":agentCommands",description:"A set of custom commands that AI agents can use.",autoStart:!0,requires:[o.INotebookTracker],activate:async(e,t)=>{console.log(`Jupyter Magic Wand plugin extension activated: ${_}:agentCommands`),e.commands.addCommand("insert-cell-below",{execute:e=>{var n,l;const o=e,i=o.cell_id,a=o.new_cell_id||void 0,c=o.cell_type;if(i){const{notebook:e}=w(i,t),s=null===(n=null==e?void 0:e.model)||void 0===n?void 0:n.sharedModel.cells.findIndex((e=>e.getId()===i));if(void 0!==s&&s>=0){const t=null===(l=null==e?void 0:e.model)||void 0===l?void 0:l.sharedModel.insertCell(s+1,{cell_type:c,metadata:{},id:a});o.source&&(null==t||t.setSource(o.source),null==e||e.update())}}}}),e.commands.addCommand("update-cell-source",{execute:e=>{var n;const l=e,o=l.cell_id;if(o){const{notebook:e}=w(o,t),i=null===(n=null==e?void 0:e.model)||void 0===n?void 0:n.sharedModel.cells.find((e=>e.getId()===o));i&&l.source&&(null==i||i.setSource(l.source),null==e||e.update(),null==e||e.content.update())}}}),e.commands.addCommand("track-if-editted",{execute:async e=>{var n;const l=e.cell_id;if(!l)return;const{cell:o,notebook:i}=w(l,t);if(void 0===o)return;await o.ready;const a=null===(n=null==i?void 0:i.model)||void 0===n?void 0:n.sharedModel.cells.find((e=>e.getId()===l));if(void 0===a)return;function c(e=!1){let t={};try{t=(null==o?void 0:o.model.getMetadata("jupyter_ai"))||{}}catch(e){t={}}const n={...t,editted:e};null==o||o.model.setMetadata("jupyter_ai",n)}c(!1);const s=function(){c(!0),null==a||a.changed.disconnect(s)};null==a||a.changed.connect(s)}})}},x=[{id:_+":plugin",description:"A cell tracker for the magic wand button.",autoStart:!0,optional:[l.ISettingRegistry],requires:[o.INotebookTracker,C.IEventListener,k.ICellFooterTracker],provides:b,activate:async(e,t,n,l)=>(console.log(`Jupyter Magic Wand plugin extension activated: ${_}:tracker`),new y(e.commands,t,n,l))},I]}}]);