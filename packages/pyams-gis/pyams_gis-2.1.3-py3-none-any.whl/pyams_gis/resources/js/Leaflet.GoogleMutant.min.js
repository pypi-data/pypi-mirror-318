import {LRUMap as a} from'./lru_map.js';const{keys:b}=Object;function A(_,B){let C=0,d=null;d=setInterval(function(){if(C>=20){clearInterval(d);throw Error('window.google not found after 10 seconds')}(window.google&&!!window.google.maps&&!!window.google.maps.Map)&&(clearInterval(d),_.call(B));++C},500)}L.GridLayer.GoogleMutant=L.GridLayer.extend({options:{maxZoom:21,type:'roadmap',maxNativeZoom:21},initialize:function(_a){L.GridLayer.prototype.initialize.call(this,_a);this._tileCallbacks={};this._lru=new a(100);this._imagesPerTile=this.options.type==='hybrid'?2:1;this._boundOnMutatedImage=this._onMutatedImage.bind(this)},onAdd:function(D){L.GridLayer.prototype.onAdd.call(this,D);this._initMutantContainer();this._logoContainer&&D._controlCorners.bottomleft.appendChild(this._logoContainer);this._attributionContainer&&D._controlCorners.bottomright.appendChild(this._attributionContainer);A(()=>{if(!this._map)return;this._initMutant();google.maps.event.addListenerOnce(this._mutant,'idle',()=>{if(!this._map)return;this._checkZoomLevels();this._mutantIsReady=!0})})},onRemove:function(_A){L.GridLayer.prototype.onRemove.call(this,_A);this._observer.disconnect();_A._container.removeChild(this._mutantContainer);this._logoContainer&&L.DomUtil.remove(this._logoContainer);this._attributionContainer&&L.DomUtil.remove(this._attributionContainer);this._mutant&&google.maps.event.clearListeners(this._mutant,'idle')},addGoogleLayer:function(e,_b){!this._subLayers&&(this._subLayers={});this.whenReady(()=>{var E=google.maps[e];var _B=new E(_b);_B.setMap(this._mutant);this._subLayers[e]=_B});return this},removeGoogleLayer:function(aA){this.whenReady(()=>{var aB=this._subLayers?.[aA];aB&&(aB.setMap(null),delete this._subLayers[aA])});return this},_initMutantContainer:function(){!this._mutantContainer&&(this._mutantContainer=L.DomUtil.create('div','leaflet-google-mutant leaflet-top leaflet-left'),this._mutantContainer.id='_MutantContainer_'+L.Util.stamp(this._mutantContainer),this._mutantContainer.style.pointerEvents='none',this._mutantContainer.style.visibility='hidden',L.DomEvent.off(this._mutantContainer));this._map.getContainer().appendChild(this._mutantContainer);this.setOpacity(this.options.opacity);var aC=this._mutantContainer.style;this._map.options.zoomSnap<1?(aC.width='180%',aC.height='180%'):(aC.width='100%',aC.height='100%');aC.zIndex=-1;this._attachObserver(this._mutantContainer)},_initMutant:function(){if(this._mutant)return;var aD={center:{lat:0,lng:0},zoom:0,tilt:0,mapTypeId:this.options.type,disableDefaultUI:!0,keyboardShortcuts:!1,draggable:!1,disableDoubleClickZoom:!0,scrollwheel:!1,styles:this.options.styles||[],backgroundColor:'transparent'};this.options.mapId!=null&&(aD.mapId=this.options.mapId);var aE=new google.maps.Map(this._mutantContainer, aD);this._mutant=aE;this._update();this.fire('spawned',{mapObject:aE});this._waitControls();this.once('controls_ready',this._setupAttribution)},_attachObserver:function aG(aF){!this._observer&&(this._observer=new MutationObserver(this._onMutations.bind(this)));this._observer.observe(aF,{childList:!0,subtree:!0});Array.prototype.forEach.call(aF.querySelectorAll('img'),this._boundOnMutatedImage)},_waitControls:function(){var aH=setInterval(()=>{const aI=this._mutant.__gm.layoutManager;if(!aI)return;clearInterval(aH);let aJ;for(const aK of b(aI)){const aL=aI[aK];if(aL.get)aL.get(1) instanceof Node&&(aJ=aL)}this.fire('controls_ready',{positions:aJ})},50)},_setupAttribution:function(aM){if(!this._map)return;var aN=google.maps.ControlPosition,_c=this._attributionContainer=aM.positions.get(aN.BOTTOM_RIGHT);L.DomUtil.addClass(_c,'leaflet-control leaflet-control-attribution');L.DomEvent.disableClickPropagation(_c);_c.style.height='14px';this._map._controlCorners.bottomright.appendChild(_c);this._logoContainer=aM.positions.get(aN.BOTTOM_LEFT);this._logoContainer.style.pointerEvents='auto';this._map._controlCorners.bottomleft.appendChild(this._logoContainer)},_onMutations:function aP(aO){for(var i=0;i<aO.length;++i){var _d=aO[i];for(var j=0;j<_d.addedNodes.length;++j){var f=_d.addedNodes[j];if(f instanceof HTMLImageElement)this._onMutatedImage(f);else f instanceof HTMLElement&&Array.prototype.forEach.call(f.querySelectorAll('img'),this._boundOnMutatedImage)}}},_roadRegexp:/!1i(\d+)!2i(\d+)!3i(\d+|VinaFnapurmBegrtn)!/,_satRegexp:/x=(\d+)&y=(\d+)&z=(\d+|VinaFnapurmBegrtn)/,_onMutatedImage:function aR(aQ){let _C;let _D=aQ.src.match(this._roadRegexp);let _e=0;if(_D){_C={z:_D[1],x:_D[2],y:_D[3]};this._imagesPerTile>1&&(aQ.style.zIndex=1,_e=1)}else{_D=aQ.src.match(this._satRegexp);_D&&(_C={x:_D[1],y:_D[2],z:_D[3]});_e=0}if(_C){var F=this._tileCoordsToKey(_C);aQ.style.position='absolute';var g=F+'/'+_e;this._lru.set(g,aQ);(g in this._tileCallbacks&&this._tileCallbacks[g])&&(this._tileCallbacks[g].forEach(aS=>aS(aQ)),delete this._tileCallbacks[g])}},createTile:function(aT,aU){const aV=this._tileCoordsToKey(aT),aW=L.DomUtil.create('div');aW.style.textAlign='left';aW.dataset.pending=this._imagesPerTile;aU=aU.bind(this,null,aW);for(var i=0;i<this._imagesPerTile;++i){const aX=aV+'/'+i,aY=this._lru.get(aX);aY?(aW.appendChild(this._clone(aY)),--aW.dataset.pending):(this._tileCallbacks[aX]=this._tileCallbacks[aX]||[],this._tileCallbacks[aX].push(function(c){return function(aZ){c.appendChild(this._clone(aZ));--c.dataset.pending;!parseInt(c.dataset.pending)&&aU()}.bind(this)}.bind(this)(aW)))}!parseInt(aW.dataset.pending)&&L.Util.requestAnimFrame(aU);return aW},_clone:function(bA){var bB=bA.cloneNode(!0);bB.style.visibility='visible';return bB},_checkZoomLevels:function(){const bC=this._map.getZoom(),bD=this._mutant.getZoom();if(!bC||!bD)return;(bD!==bC||bD>this.options.maxNativeZoom)&&this._setMaxNativeZoom(bD)},_setMaxNativeZoom:function(bE){bE!==this.options.maxNativeZoom&&(this.options.maxNativeZoom=bE,this._resetView())},_update:function(bF){if(this._mutant){bF=bF||this._map.getCenter();const bG=Math.round(this._map.getZoom()),bH=this._mutant.getZoom();this._mutant.setCenter(new google.maps.LatLng(bF.lat, bF.lng));if(bG!==bH){this._mutant.setZoom(bG);this._mutantIsReady&&this._checkZoomLevels()}}L.GridLayer.prototype._update.call(this,bF)},whenReady:function(bI,bJ){this._mutant?bI.call(bJ||this,{target:this}):this.on('spawned',bI,bJ);return this}});L.gridLayer.googleMutant=bK=>new L.GridLayer.GoogleMutant(bK);
